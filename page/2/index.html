<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Page 2 | 我是你爸爸</title>
  <meta name="author" content="杨鑫诚Bruce">
  
  <meta name="description" content="我是你爸爸">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="我是你爸爸"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="我是你爸爸" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">我是你爸爸</a></h1>
  <h2><a href="/">在动物园散步才是正经事</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-11-17T15:25:00.000Z"><a href="/2013/11/17/angular-grunt-ngtemplates/">Nov 17 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/11/17/angular-grunt-ngtemplates/">grunt angular templates</a></h1>
  

    </header>
    <div class="entry">
      
        <p><a href="https://github.com/ericclemmons/grunt-angular-templates" target="_blank">grunt-angular-templates</a>
模板文件会导致每次都去服务器请求..
使用 grunt-angular-templates grunt build时 将模板文件转为js文件
(html-&gt;stirng-&gt;$templateCache)
再通过manifest作本地cache
妥妥的..</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre>ngtemplates:
  dist:
    options:
      base: <span class="comment">'<span class="xmlDocTag">&lt;%= yeoman.app %&gt;</span>'</span>
      <span class="preprocessor"># concat: '&lt;%= yeoman.dist %&gt;/scripts/scripts.js'</span>
      <span class="keyword">module</span>: yeomanConfig.name
    cwd: <span class="comment">'<span class="xmlDocTag">&lt;%= yeoman.app %&gt;</span>'</span>
    src: <span class="comment">'views/**.html'</span>
    dest: <span class="comment">'.tmp/scripts/templateCache.js'</span>
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"scripts/templateCache.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
</pre></td></tr></table></figure>


      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-11-14T17:00:00.000Z"><a href="/2013/11/15/angular-test-patterns/">Nov 15 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/11/15/angular-test-patterns/">angular test patterns</a></h1>
  

    </header>
    <div class="entry">
      
        <p>发现一个好的项目  值得学习
<a href="https://github.com/daniellmb/angular-test-patterns" target="_blank">angular-test-patterns</a></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-11-13T14:00:00.000Z"><a href="/2013/11/13/angular-test/">Nov 13 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/11/13/angular-test/">angular test mock</a></h1>
  

    </header>
    <div class="entry">
      
        <h3 id="mock-a-socket-service-for-unit-test">mock a socket service for unit test</h3>
<p>就像httpbackend一样 我们不希望 对于socket的相关测试 会影响到真实的项目
所以同样采用mock socket 代替真实socket service
angular中 service 采用后注册替代之前注册的原则</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre>angular.<span class="built_in">module</span>(<span class="string">'ChatWebClient'</span>)
  .factory <span class="string">'Socket'</span>, [
    <span class="string">'$rootScope'</span>
    <span class="function"><span class="params">($rootScope)</span> -&gt;</span>
      <span class="attribute">events</span>: {}
      <span class="attribute">instance</span>: sinon.spy<span class="function"> -&gt;</span>
        <span class="comment">##</span>
      <span class="attribute">on</span>: sinon.spy <span class="function"><span class="params">(eventName, callback)</span> -&gt;</span>
        <span class="property">@events</span>[eventName] = [] <span class="keyword">unless</span> <span class="property">@events</span>[eventName]
        <span class="property">@events</span>[eventName].push callback
      <span class="attribute">emit</span>: sinon.spy <span class="function"><span class="params">(eventName, data, emitCallback)</span> -&gt;</span>
        _.each <span class="property">@events</span>[eventName], <span class="function"><span class="params">(callback)</span> -&gt;</span>
          $rootScope.$apply<span class="function"> -&gt;</span>
            callback data
        emitCallback?()
    ]
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre>beforeEach -&gt;
  module <span class="string">'ChatWebClient'</span> <span class="comment"># inject mock socket</span>

  inject (<span class="variable">$rootScope</span>, <span class="variable">$controller</span>, Socket) -&gt;
    scope = <span class="variable">$rootScope</span>.<span class="variable">$new</span>()
    socketMock = Socket
    notifierMock =
      <span class="keyword">send</span>: sinon.spy()
    <span class="variable">$controller</span> <span class="string">'NavCtrl'</span>,
      <span class="variable">$scope</span>: scope
      Notifier: notifierMock

it <span class="string">'when the socket disconnect, then app will send a notification to show this situation'</span>, -&gt;
  socketMock.emit <span class="string">'disconnect'</span>
  notifierMock.<span class="keyword">send</span>.should.have.been.called

it <span class="string">'when the socket error, then app will send a notification to show this situation'</span>, -&gt;
  socketMock.emit <span class="string">'error'</span>
  notifierMock.<span class="keyword">send</span>.should.have.been.called
<span class="string">`</span>
</pre></td></tr></table></figure>

<p><strong><code>这种通过注册mock service的方法  看到被应用在unit controller test中 没有深入的研究 也mark下</code></strong></p>
<h3 id="-timeout-rootscope-broadcast">$timeout $rootscope.$broadcast</h3>
<ul>
<li>angularjs 1.2中可以直接使用$timeout.flush()</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="keyword">it</span> 'when <span class="keyword">the</span> notification`s handler be called
    <span class="keyword">then</span> notification should be <span class="command">read</span> <span class="keyword">after</span> <span class="number">2000</span>ms', inject ($<span class="keyword">timeout</span>) -&gt;
    res = notifier.send {}
    res.handler.apply null
    $<span class="keyword">timeout</span>.flush <span class="number">2001</span>
    res.<span class="command">read</span>.should.be.<span class="constant">true</span>
</pre></td></tr></table></figure>

<ul>
<li>测试$rootscope.$broadcast 是否被执行</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre>it <span class="string">'when the notification then rootscope will broadcast a message'</span>, inject (<span class="variable">$rootScope</span>) -&gt;
  sinon.spy <span class="variable">$rootScope</span>, <span class="string">'$broadcast'</span>
  res = notifier.<span class="keyword">send</span> {}
  <span class="variable">$broadcast</span>.should.have.been.calledWith <span class="string">'notifier.newNotification'</span>
  <span class="variable">$rootScope</span>.<span class="variable">$broadcast</span>.restore()
</pre></td></tr></table></figure>

<p>Have fun!</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-11-12T13:00:00.000Z"><a href="/2013/11/12/angular-e2e-test/">Nov 12 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/11/12/angular-e2e-test/">angular e2e test</a></h1>
  

    </header>
    <div class="entry">
      
        <p>有个angular e2e test 的框架 Protractor 基于WebDriverJS 很火..但是没用过..
 我理解的e2e test 就是功能 行为 表现 场景 (性能)..
 angular 封装了很多用来e2e测试的工具方法</p>
<h3 id="sample">sample</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre> <span class="keyword">it</span> <span class="string">'when signin failed then will stay on this page '</span>, -&gt;
    browser().navigateTo <span class="string">'/'</span>
    pause()
    keyboard().keydown <span class="constant">null</span>, <span class="string">'keydown'</span>, <span class="number">13</span>, <span class="constant">false</span>, <span class="constant">false</span>
    input(<span class="string">'name'</span>).enter(<span class="string">'csr1'</span>)
    input(<span class="string">'password'</span>).enter(<span class="string">'csr3'</span>)
    <span class="keyword">element</span>(<span class="string">'button[type="submit"]'</span>).click()
    expect(browser().location().path()).toBe(<span class="string">'/signin'</span>)
    <span class="comment"># pause()</span>
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
</pre></td><td class="code"><pre><span class="keyword">it</span> <span class="string">'when click the side customer then will show a chat window'</span>, -&gt;
    <span class="keyword">element</span>(<span class="string">'.side-main ul li.customer:eq(0)'</span>).click()
    expect(repeater(<span class="string">'.chat-box'</span>).count()).toBe(<span class="number">1</span>)
    <span class="comment"># pause()</span>
</pre></td></tr></table></figure>

<h3 id="-httpbackend-in-e2e-test">$httpBackend in e2e test</h3>
<ul>
<li>including angular-mocks.js in the index.html</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"bower_components/angular-mocks/angular-mocks.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
</pre></td></tr></table></figure>

<ul>
<li>create a mock module for e2e test (注入app module)</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="code"><pre>angular.module(<span class="string">'e2e-mocks'</span>,
  [
    <span class="string">'ngMockE2E'</span>
  ]).run [
    <span class="string">'$httpBackend'</span>
    ($httpBackend) -&gt;
      customers = [
        <span class="keyword">...</span>
      ]

      histories = [
        <span class="keyword">...</span>
      ]

      broadcastHistories = [
        <span class="keyword">...</span>
      ]

      $httpBackend.whenGET(/views\/*/).passThrough()
      $httpBackend.whenGET(/csr\/customers\/*/).respond customers
      $httpBackend.whenGET(/messages\/csr\/*/).respond histories
      $httpBackend.whenGET(/messages\/broadcast\/*/).respond broadcastHistories
      $httpBackend.whenGET(/messages\/unread\/*/).respond []
    ]

angular.module(<span class="string">'ChatWebClient'</span>).requires.push <span class="string">'e2e-mocks'</span>
</pre></td></tr></table></figure>

<ul>
<li>including this js file in the index.html</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"scripts/mocks.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
</pre></td></tr></table></figure>

<h3 id="extending-the-scenario-dsl">extending the scenario dsl</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre>angular.scenario.dsl <span class="string">'keyboard'</span>,<span class="function"> -&gt;</span>
  chain  = {}
  chain.<span class="function"><span class="title">keydown</span> = <span class="params">(selector, keyEvent, keyCode, shift, ctrl)</span> -&gt;</span>
    <span class="keyword">this</span>.addFutureAction <span class="string">'keyEvent'</span>, <span class="function"><span class="params">($<span class="built_in">window</span>, $<span class="built_in">document</span>, done)</span> -&gt;</span>
      jQuery = $<span class="built_in">window</span>.$
      e = jQuery.Event(keyEvent)
      e.which = keyCode <span class="comment"># Some key code value</span>
      e.altKey = <span class="literal">false</span>
      e.ctrlKey = ctrl
      e.shiftKey = shift
      <span class="keyword">if</span> selector <span class="keyword">is</span> <span class="literal">null</span>
        selector = <span class="string">'*:focus'</span>
      j = jQuery(selector)
      <span class="keyword">if</span> j <span class="keyword">is</span> <span class="literal">null</span>
        j = jQuery(<span class="string">'body'</span>)
      j.trigger(e)
      done()

  <span class="keyword">return</span> <span class="function"><span class="params">()</span> -&gt;</span>
    chain
</pre></td></tr></table></figure>

<p>Have fun!</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-11-08T16:10:38.000Z"><a href="/2013/11/09/angular-unit-test/">Nov 9 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/11/09/angular-unit-test/">angular unit test</a></h1>
  

    </header>
    <div class="entry">
      
        <p>首先要说一个angularjs test的坑
如果你在项目中使用$logProvider.debugEnabled来配置是否开启$log.debug功能
恭喜你!angluar-mock 1.0.8版本中并没有实现debugEnabled方法
需要手动配置bower中anguar-mock 版本为1.2.0(目前bower设置为 * 默认会使用1.0.8版本)</p>
<p>进入正题:
我直接将angular unit test framework换成了mocha...
另外发现npm中有karma-sinon-chai 果断换了
虽然github加星寥寥无几 但是省了自己配置</p>
<h3 id="unit-test-directive-jquery-">unit test directive (可以使用jquery)</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="code"><pre>app = angular.<span class="built_in">module</span> <span class="string">'App'</span>, []
app.directive <span class="string">'sample'</span>,<span class="function"> -&gt;</span>
  <span class="function"><span class="params">(scope, elem, attrs)</span> -&gt;</span>
    elem.bind <span class="string">'click'</span>,<span class="function"> -&gt;</span>
      elem.text scope.$eval(attrs.sample)

<span class="comment">#test</span>
describe <span class="string">'test the sample directive'</span>,<span class="function"> -&gt;</span>
  scope = <span class="literal">null</span>
  elem = <span class="literal">null</span>
  html = <span class="literal">null</span>

  beforeEach<span class="function"> -&gt;</span>
    <span class="built_in">module</span> <span class="string">'app'</span>
    html = <span class="string">'&lt;div sample="foo"&gt;&lt;/div&gt;'</span>
    inject <span class="function"><span class="params">($compile, $rootScope)</span> -&gt;</span>
      scope = $rootScope.$<span class="keyword">new</span>()
      elem = angular.element(html)
      $compile(elem)(scope)
      scope.$digest()

  it <span class="string">'should set the text of the element to foo'</span>,<span class="function"> -&gt;</span>
    scope.foo = <span class="string">'foo'</span>
    (elem.text()).should.equal <span class="string">''</span>
    elem[<span class="number">0</span>].click()
    elem.text()).should.equal <span class="string">'foo'</span>
</pre></td></tr></table></figure>

<h3 id="unit-test-controller">unit test controller</h3>
<p>如果存在service 注入
使用mock service
测试spy</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td><td class="code"><pre>app.controller <span class="string">'MainCtrl'</span>,
  [
    <span class="string">'$scope'</span>
    <span class="string">'Service'</span>
    (<span class="variable">$scope</span>, Service) -&gt;
      <span class="variable">$scope</span>.foo = <span class="string">'foo'</span>
      <span class="variable">$scope</span>.baz = <span class="string">'baz'</span>
      <span class="variable">$scope</span>.testFunc1 = -&gt;
        <span class="variable">$scope</span>.foo = <span class="string">'hello '</span> + <span class="variable">$scope</span>.foo
      <span class="variable">$scope</span>.testFunc2 = -&gt;
        Service.method <span class="variable">$scope</span>.baz
      <span class="variable">$scope</span>.<span class="variable">$watch</span> <span class="string">'baz'</span>, (newVal, oldVal) -&gt;
        <span class="variable">$scope</span>.baz = newVal + <span class="string">' hello'</span> unelss newVal is oldVal
  ]

app.factory <span class="string">'Service'</span>,
  [
    () -&gt;
      method: (text) -&gt;
        <span class="comment">#something</span>
  ]

<span class="comment">#test</span>
describe <span class="string">'test MainCtrl controller'</span>, -&gt;
  <span class="variable">$scope</span> = <span class="keyword">null</span>
  mainCtrl = <span class="keyword">null</span>
  mockService = <span class="keyword">null</span>

  beforeEach -&gt;
    module <span class="string">'myApp'</span>
    inject (<span class="variable">$rootScope</span>, <span class="variable">$controller</span>) -&gt;
      <span class="variable">$scope</span> = <span class="variable">$rootScope</span>.<span class="variable">$new</span>()
      mockService =
        method: sinon.spy()
      ctrl = <span class="variable">$controller</span> <span class="string">'MainCtrl'</span>,
        <span class="variable">$scope</span>: <span class="variable">$scope</span>,
        Service: mockService

  it <span class="string">'foo should be foor'</span>, -&gt;
    <span class="variable">$scope</span>.foo.should.equal <span class="string">'foo'</span>

  it <span class="string">'should add hello before foo when testFunc1() is called'</span>, -&gt;
    <span class="variable">$scope</span>.testFunc1()
    <span class="variable">$scope</span>.foo.should.equal <span class="string">'hello foo'</span>

  it <span class="string">'should update baz when baz is changed'</span>, -&gt;
    <span class="variable">$scope</span>.bar = <span class="string">'world'</span>
    <span class="variable">$scope</span>.<span class="variable">$apply</span>()
    <span class="variable">$scope</span>.baz.should.equal <span class="string">'world hello'</span>

  it <span class="string">'should make a call to Service.method()
    when testFunc2() is called'</span>, -&gt;
    <span class="variable">$scope</span>.testFunc2()
    mockService.method.should.have.been.calledOnce
</pre></td></tr></table></figure>

<h3 id="unit-test-service">unit test service</h3>
<p>service的测试我认为是最重要的
service可以被注入到controller serivce
在anguarjs中占有很重要的地位</p>
<ul>
<li>test a sample service</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="code"><pre>app.factory <span class="string">'Chats'</span>,
  [
    <span class="function"><span class="params">()</span> -&gt;</span>
      chats = []
      <span class="comment">#factory</span>
      <span class="attribute">getChats</span>:<span class="function"> -&gt;</span>
        chats
      <span class="attribute">setChats</span>: <span class="function"><span class="params">(data)</span> -&gt;</span>
        chats = data
      <span class="attribute">getChat</span>: <span class="function"><span class="params">(id)</span> -&gt;</span>
        _.find chats, <span class="function"><span class="params">(chat)</span> -&gt;</span>
          chat.id <span class="keyword">is</span> id
  ]

<span class="comment">#test</span>
mockData = [
  <span class="attribute">id</span>:<span class="number">1</span>
  <span class="attribute">name</span>: <span class="string">'customer1'</span>
,
  <span class="attribute">id</span>:<span class="number">2</span>
  <span class="attribute">name</span>: <span class="string">'customer2'</span>
]
describe <span class="string">'test Chats service'</span>,<span class="function"> -&gt;</span>
  chats = <span class="literal">null</span>
  beforeEach<span class="function"> -&gt;</span>
    <span class="built_in">module</span> <span class="string">'App'</span>
    inject <span class="function"><span class="params">(Chats)</span> -&gt;</span>
      chats = Chats

  it <span class="string">'should have setChats getChats getChat functions'</span>,<span class="function"> -&gt;</span>
    ((_.isFunction chats.setChats)
    && (_.isFunction chats.getChats)
    && (_.isFunction chats.getChat)).should.be.<span class="literal">true</span>

  it <span class="string">'should get some chats when
    setChats(mock_data) is called'</span><span class="function"> -&gt;</span>
    chats.setChats mockData
    chat.getChats().length.should.equal(<span class="number">2</span>)

  it <span class="string">'should get a chat which id is customer1'</span>,<span class="function"> -&gt;</span>
    chat.getChats(<span class="string">'customer1'</span>).should.exist
</pre></td></tr></table></figure>

<ul>
<li>use $httpBackend to test a service with $http</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="code"><pre>app.service(<span class="string">'Service'</span>, [
  <span class="string">'$resource'</span>
  <span class="string">'Config'</span>
  <span class="function"><span class="params">($resource, Config)</span> -&gt;</span>
    <span class="comment">#service</span>
    <span class="property">@customers</span> = $resource <span class="string">'/csr/customers'</span>, {}

app.factory <span class="string">'Customers'</span>,
  [
    <span class="string">'Service'</span>
    <span class="function"><span class="params">(Service)</span> -&gt;</span>
      <span class="comment">#factory</span>
      <span class="attribute">fetch</span>:<span class="function"> -&gt;</span>
        Service.customers.query()
  ]

<span class="comment">#test</span>
describe <span class="string">'test Customers service'</span>,<span class="function"> -&gt;</span>
  httpBackend = <span class="literal">null</span>
  customers = <span class="literal">null</span>
  beforeEach<span class="function"> -&gt;</span>
    <span class="built_in">module</span> <span class="string">'App'</span>

  inject <span class="function"><span class="params">($httpBackend, Customers)</span> -&gt;</span>
    customers = Customers
    httpBackend = $httpBackend

  <span class="comment">#make sure no expectations were missed</span>
  afterEach<span class="function"> -&gt;</span>
    httpBackend.verifyNoOutstandingExpectation()
    httpBackend.verifyNoOutstandingRequest()

  it <span class="string">'should get a customer whose name is customer1
    when Customers.fetch() is called'</span>,<span class="function"> -&gt;</span>
    mockData = [
      <span class="attribute">id</span>: <span class="number">1</span>
      <span class="attribute">name</span>: <span class="string">'customer1'</span>
    ,
      <span class="attribute">id</span>: <span class="number">2</span>
      <span class="attribute">name</span>: <span class="string">'customer2'</span>
    ]
    $httpBackend.expectGET(<span class="string">'/csr/customers/\*/'</span>).respond mockData
    result = customers.fetch()
    $httpBackend.flush()
    <span class="function"><span class="params">(_.find reuslt, (item) -&gt; item.name <span class="keyword">is</span> <span class="string">'customer1'</span>)</span>.<span class="title">should</span>.<span class="title">exsit</span></span>
</pre></td></tr></table></figure>

<ul>
<li>test a service with dependencies</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="code"><pre>app.factory <span class="string">'Storage'</span>,
  [
    $<span class="built_in">window</span>
    <span class="function"><span class="params">($<span class="built_in">window</span>)</span> -&gt;</span>
      storage =  $<span class="built_in">window</span>.localStorage
      <span class="comment">#factory</span>
      <span class="attribute">message</span>:
        <span class="attribute">add</span>: <span class="function"><span class="params">(msgs)</span> -&gt;</span>
            <span class="comment">#add to storage</span>
  ]

app.factory <span class="string">'Message'</span>,
  [
    <span class="string">'Storage'</span>
    <span class="function"><span class="params">(Storage)</span> -&gt;</span>
      <span class="comment">#factory</span>
      <span class="attribute">receivedMessage</span>: <span class="function"><span class="params">(msg)</span> -&gt;</span>
        Storage.message.add msg
  ]

<span class="comment">#test</span>
describe <span class="string">'test Messsage service'</span>,<span class="function"> -&gt;</span>
  message = <span class="literal">null</span>
  mockStorage = <span class="literal">null</span>

  beforeEach<span class="function"> -&gt;</span>
    <span class="built_in">module</span> <span class="string">'App'</span>, <span class="function"><span class="params">($provide)</span> -&gt;</span>
      mockStorage =
        <span class="attribute">add</span>: sinon.spy()
      $provide.value <span class="string">'Storage'</span>, mockStorage
      <span class="keyword">return</span> <span class="comment">#for coffee</span>
    inject <span class="function"><span class="params">(Message)</span> -&gt;</span>
      message = Message

  it <span class="string">'should call Storage.add()
    when Message.receivedMessage passing through message params'</span>,<span class="function"> -&gt;</span>
    message.receivedMessage
      <span class="attribute">fromId</span>: <span class="string">'customer1'</span>
      <span class="attribute">toId</span>: <span class="string">'csr3'</span>
      <span class="attribute">content</span>: <span class="string">'hello world'</span>
    mockStorage.add.should.have.been.calledWithMatch
      <span class="attribute">fromId</span>: <span class="string">'customer1'</span>
      <span class="attribute">toId</span>: <span class="string">'csr3'</span>
      <span class="attribute">content</span>: <span class="string">'hello world'</span>
</pre></td></tr></table></figure>

<p>完毕~
下次写e2e test</p>
<p>Have fun!</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-11-08T14:00:00.000Z"><a href="/2013/11/08/angular-karma/">Nov 8 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/11/08/angular-karma/">angular karma</a></h1>
  

    </header>
    <div class="entry">
      
        <h3 id="karma-">karma配置</h3>
<p>修改了karma的配置 可以直接对coffee文件执行
遇到几个问题</p>
<ul>
<li>文件匹配采用的是minMatch语法</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
</pre></td><td class="code"><pre><span class="string">"app/views/*.html"</span>
<span class="string">"app/scripts/**/!(mock).coffee"</span>
<span class="string">"test/mock/unit-mocks.coffee"</span>
<span class="string">"test/spec/**/*.coffee"</span>
</pre></td></tr></table></figure>

<ul>
<li>coffee文件需要预执行 html模板使用ng-html2js预处理</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre>preprocessors:
  <span class="string">"app/scripts/**/!(mock).coffee"</span>: <span class="string">"coffee"</span>
  <span class="string">"test/mock/unit-mocks.coffee"</span>: <span class="string">"coffee"</span>
  <span class="string">"test/spec/**/*.coffee"</span>: <span class="string">"coffee"</span>
  <span class="string">'app/views/*.html'</span>: <span class="string">'ng-html2js'</span>
</pre></td></tr></table></figure>

<p>Have fun!</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-11-06T14:00:00.000Z"><a href="/2013/11/06/angular-grunt/">Nov 6 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/11/06/angular-grunt/">angular grunt</a></h1>
  

    </header>
    <div class="entry">
      
        <h3 id="grunt-">grunt配置</h3>
<ul>
<li>grunt stylus</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
</pre></td><td class="code"><pre>stylus:
  compile:
    options:
      <span class="built_in">compress</span>: <span class="constant">true</span>
      paths: [<span class="string">'node_modules/grunt-contrib-stylus/node_modules'</span>]
    <span class="built_in">files</span>:
      <span class="string">'app/styles/site.css'</span>: <span class="string">'app/styles/site.styl'</span>
</pre></td></tr></table></figure>

<ul>
<li>grunt htmlmin
2级目录下的html file不会自动 use min
修改如下:</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre>htmlmin:
  dist:
    options: {}
    <span class="built_in">files</span>: [
      expand: <span class="constant">true</span>
      cwd: <span class="string">"&lt;%= yeoman.app %&gt;"</span>
      src: [
        <span class="string">"*.html"</span>
        <span class="string">"views/*.html"</span>
      ]
      dest: <span class="string">"&lt;%= yeoman.dist %&gt;"</span>
    ]
</pre></td></tr></table></figure>

<ul>
<li>grunt mainfest</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre>manifest:
  generate:
    options:
      basePath: <span class="string">'dist/'</span>
      preferOnline: <span class="literal">true</span>
      verbose: <span class="literal">true</span>
      timestamp: <span class="literal">true</span>
      <span class="built_in">hash</span>: <span class="literal">true</span>
      master: [<span class="string">'index.html'</span>]
    src: [
      <span class="string">'scripts/*.js'</span>
      <span class="string">'styles/*.css'</span>
      <span class="string">'images/*'</span>
      <span class="string">'fonts/*'</span>
    ]
    dest: <span class="string">'dist/appcache.manifest'</span>
</pre></td></tr></table></figure>

<p>Have fun!</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-11-05T14:17:38.000Z"><a href="/2013/11/05/angular-yeoman/">Nov 5 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/11/05/angular-yeoman/">angular yeoman</a></h1>
  

    </header>
    <div class="entry">
      
        <h3 id="yeoman-coffee">yeoman coffee</h3>
<p>yeaman generate angular --coffee生成的项目 index.html 中</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre><span class="comment">&lt;!-- build:js(.tmp, app) scripts/scripts.js --&gt;</span>
  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"scripts/app.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
</pre></td></tr></table></figure>

<p>存在一些问题，如果我安装了coffee auto compile插件
那么app目录下会有一份js文件
concurrent coffee task 又会把app下的coffee compile到 .tmp下面...
这样concat task 就会把重复的js concat
不修改coffee task配置的前提下 改为build:js(.tmp)</p>
<p>Have fun!</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-11-03T15:56:29.000Z"><a href="/2013/11/03/angular-learning/">Nov 3 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/11/03/angular-learning/">angular learning</a></h1>
  

    </header>
    <div class="entry">
      
        <p>最近忙于一个angular+socket.io的项目遇到一些问题mark下</p>
<h3 id="-digest">$digest</h3>
<p>50ms的全局dirty-check毕竟会带来一些性能问题
比如list数量很多 会造成比较lag的现象
<a href="http://tech.small-improvements.com/2013/09/10/angularjs-performance-with-large-lists/" target="_blank">解决方式如下</a>
1.Pagination
2.<a href="http://binarymuse.github.io/ngInfiniteScroll/" target="_blank">Infinite scrolling</a>
3.<a href="https://github.com/Pasvaz/bindonce" target="_blank">Render the list without data binding</a>
4.Do not use a inline method call for calculating the data
5.Use two lists noe for the view display on as data source
6.Use ng-if instead of ng-show for additional templates
7.Do not use AngularJS directives ng-mouseenter, ng-mouseleave, etc.
8.Tuning hint for filtering: Hide elements with ng-show that are excluded
9.另外要注意filter   angular中input textarea在keypress等事件触发时 会触发全局digest filter会重复重复执行</p>
<h3 id="cors">cors</h3>
<p>平时jquery使用过度 导致对于cors这类问题没有深入的研究 在使用$http或者$resource时就遇到了这类问题
比如cors post时的options preflight
jquery 避免了options请求
HTTP方法是下列之一
HEAD
GET
POST
HTTP头包含
Accept
Accept-Language
Content-Language
Last-Event-ID
Content-Type，但仅能是下列之一
    application/x-www-form-urlencoded
    multipart/form-data
    text/plain
任何一个不满足上述要求的请求 即被认为是复杂请求 一个复杂请求不仅有包含通信内容的请求 同时也包preflight request</p>
<p>首先服务端要支持cors</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
</pre></td><td class="code"><pre>res.header <span class="string">'Access-Control-Allow-Origin'</span>, req.headers.origin #<span class="string">'*'</span>
res.header <span class="string">'Access-Control-Allow-Methods'</span>, <span class="string">'GET,PUT,POST,DELETE,OPTIONS'</span>
res.header <span class="string">'Access-Control-Allow-Headers'</span>, <span class="string">'Content-Type, Authorization, Content-Length, X-Requested-With'</span>
#intercept OPTIONS <span class="function"><span class="keyword">method</span>
<span class="title">if</span> '<span class="title">OPTIONS</span>' <span class="title">is</span> <span class="title">req</span>.<span class="title">method</span>
    <span class="title">return</span> <span class="title">res</span>.<span class="title">send</span> 200
<span class="title">next</span><span class="params">()</span>;</span>
</pre></td></tr></table></figure>

<p>angular config里配置$http headers</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre><span class="variable">$httpProvider</span>.defaults.useXDomain = <span class="literal">true</span>
delete <span class="variable">$httpProvider</span>.defaults.headers.common[<span class="string">'X-Requested-With'</span>]
</pre></td></tr></table></figure>

<h3 id="client-auth">client auth</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre>app.config [
  <span class="string">'$httpProvider'</span>
  <span class="function"><span class="params">($httpProvider)</span> -&gt;</span>
    <span class="comment">#401 403</span>
    interceptor = [
      <span class="string">'$rootScope'</span>
      <span class="string">'$q'</span>
      <span class="function"><span class="params">($rootScope, $q)</span> -&gt;</span>
        <span class="function"><span class="title">success</span> = <span class="params">(response)</span> -&gt;</span>
          response
        <span class="function"><span class="title">error</span> = <span class="params">(response)</span> -&gt;</span>
          <span class="keyword">if</span> response.status <span class="keyword">is</span> <span class="number">401</span> <span class="keyword">or</span> response.status <span class="keyword">is</span> <span class="number">403</span>
            deferred = $q.defer()
            $rootScope.$broadcast <span class="string">'auth_failed'</span>
            deferred.promise
          <span class="keyword">else</span>
            $q.reject(response)
        <span class="function"><span class="params">(promise)</span> -&gt;</span>
          promise.<span class="keyword">then</span> success, error
    ]
    $httpProvider.responseInterceptors.push interceptor
  ]
</pre></td></tr></table></figure>

<p>另外对于controller权限的控制 可以参考
<a href="https://github.com/fnakstad/angular-client-side-auth" target="_blank">angular-client-side-auth</a></p>
<h3 id="select-and-options">select and options</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre>$scope.options = ({<span class="keyword">val</span>:key, text:<span class="keyword">val</span>, checked:<span class="keyword">false</span>} <span class="keyword">for</span> key,<span class="keyword">val</span> <span class="keyword">of</span> Config.customerStatusMap)

&lt;label <span class="keyword">class</span>=<span class="string">"checkbox-inline"</span> ng-repeat=<span class="string">"option in options"</span>&gt;
  &lt;input <span class="class"><span class="keyword">type</span>=</span><span class="string">"checkbox"</span> <span class="keyword">value</span>=<span class="string">""</span> ng-click=<span class="string">"option.checked = !option.checked"</span>&gt; 
&lt;/label&gt;
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre>$<span class="transposed_variable">scope.</span>customers = <span class="matrix">[
  name: <span class="string">'林萧'</span>
  username: <span class="string">'customer2'</span>
  csrname: <span class="string">'csr3'</span>
  csrId: <span class="number">103</span>
,
  name: <span class="string">'顾里'</span>
  username: <span class="string">'customer3'</span>
  csrname: <span class="string">'csr3'</span>
  csrId: <span class="number">103</span>
]</span>

&lt;<span class="keyword">select</span> class=<span class="string">"form-control"</span>
  ng-model=<span class="string">"selected_customer"</span>
  ng-options=<span class="string">"customer as customer.name + '</span>-&gt;<span class="string">' + customer.csrname + '</span>(<span class="string">' + customer.csrId  + '</span>)<span class="string">' for customer in customers"</span>&gt;
&lt;/<span class="keyword">select</span>&gt;
</pre></td></tr></table></figure>

<h3 id="provider-service-factory-">provider service factory..</h3>
<p>singleton
关于什么时候用什么
service  instance of a function
factory  sharing utility functions
我理解为 我只是想暴露几个属性 service
我想要暴露一堆方法 factory
特别需要注意:  contant  和   value</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
</pre></td><td class="code"><pre><span class="keyword">function</span> constant(name, <span class="keyword">value</span>) {
  providerCache[name] = <span class="keyword">value</span>;
  instanceCache[name] = <span class="keyword">value</span>;
}
</pre></td></tr></table></figure>

<p>value可以被修改 constant一旦声明无法被修改
value不可在config里注入 constant可以</p>
<h3 id="when-to-user-serivce-and-controller">when to user serivce and controller</h3>
<p>这个问题一直困扰着我 现在也没有特别好的解决
个人感觉angluar应该是controller尽量的轻 controller里的function property用来html data-bind或者间接为此用途
service不单单是简单的类似接口
1.Services As Application Helpers
2.Services As Communication Hubs
3.Services As Injectable Dependencies
不像backbone controller很重
但对于 Keep business logic inside Controllers and data logic inside services
有点迷茫
后期会继续学习</p>
<p>Have fun!</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-11-01T14:56:30.000Z"><a href="/2013/11/01/start/">Nov 1 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/11/01/start/">start</a></h1>
  

    </header>
    <div class="entry">
      
        <p>用hexo重新搭建了下blog 顺手改了css+html 加上weibo连接
今天就到这
以后写不写blog 看心情</p>
<p>Have fun!</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




<nav id="pagination">
  
    <a href="/" class="alignleft prev">Prev</a>
  
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:yoursite.com">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/blog/">blog</a><small>3</small></li>
  
    <li><a href="/categories/titanium/">titanium</a><small>1</small></li>
  
    <li><a href="/categories/web/">web</a><small>16</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/angularjs/">angularjs</a><small>15</small></li>
  
    <li><a href="/tags/audio/">audio</a><small>1</small></li>
  
    <li><a href="/tags/bootstrap/">bootstrap</a><small>1</small></li>
  
    <li><a href="/tags/grunt/">grunt</a><small>1</small></li>
  
    <li><a href="/tags/karma/">karma</a><small>1</small></li>
  
    <li><a href="/tags/mic/">mic</a><small>1</small></li>
  
    <li><a href="/tags/summary/">summary</a><small>1</small></li>
  
    <li><a href="/tags/test/">test</a><small>4</small></li>
  
    <li><a href="/tags/titanium/">titanium</a><small>2</small></li>
  
    <li><a href="/tags/war3/">war3</a><small>1</small></li>
  
    <li><a href="/tags/wcg/">wcg</a><small>1</small></li>
  
    <li><a href="/tags/yeoman/">yeoman</a><small>1</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2014 杨鑫诚Bruce
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>